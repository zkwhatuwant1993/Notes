# sql基础(Structured Query Language)

## 目录

- [sql基础(Structured Query Language)](#sql%E5%9F%BA%E7%A1%80structured-query-language)
    - [目录](#%E7%9B%AE%E5%BD%95)
    - [基本概念](#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5)
        - [1. 数据库和数据库管理系统](#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F)
        - [2. 数据库的种类](#2-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%A7%8D%E7%B1%BB)
        - [3. Database和DBMS的作用](#3-database%E5%92%8Cdbms%E7%9A%84%E4%BD%9C%E7%94%A8)
        - [4. SQL概要](#4-sql%08%08%08%E6%A6%82%E8%A6%81)
        - [5. 创建数据库和表](#5-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8)
    - [查询基础](#%E6%9F%A5%E8%AF%A2%E5%9F%BA%E7%A1%80)
        - [1. SELECT语句基础](#1-select%E8%AF%AD%E5%8F%A5%E5%9F%BA%E7%A1%80)
        - [2. 运算符](#2-%E8%BF%90%E7%AE%97%E7%AC%A6)
    - [聚合与排序](#%E8%81%9A%E5%90%88%E4%B8%8E%E6%8E%92%E5%BA%8F)
        - [1. 聚合函数](#1-%E8%81%9A%E5%90%88%08%E5%87%BD%E6%95%B0)
        - [2. 分组统计（分类汇总GROUP BY）](#2-%E5%88%86%E7%BB%84%E7%BB%9F%E8%AE%A1%EF%BC%88%E5%88%86%E7%B1%BB%E6%B1%87%E6%80%BBgroup-by%EF%BC%89)
        - [3. 对查询结果进行排序(ORDER BY)](#3-%E5%AF%B9%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8Forder-by)
    - [数据更新](#%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0)
        - [1. 向表中插入数据:INSERT](#1-%E5%90%91%E8%A1%A8%E4%B8%AD%08%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AEinsert)
        - [2. 删除表中数据](#2-%E5%88%A0%E9%99%A4%E8%A1%A8%E4%B8%AD%E6%95%B0%E6%8D%AE)
        - [3. 更新表中数据](#3-%E6%9B%B4%E6%96%B0%E8%A1%A8%E4%B8%AD%E6%95%B0%E6%8D%AE)
        - [4. 事务](#4-%E4%BA%8B%E5%8A%A1)
    - [5. 复杂查询](#5-%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2)
        - [1. 视图](#1-%E8%A7%86%E5%9B%BE)
        - [2. 子查询（嵌套查询）](#2-%E5%AD%90%E6%9F%A5%E8%AF%A2%EF%BC%88%E5%B5%8C%E5%A5%97%E6%9F%A5%E8%AF%A2%EF%BC%89)
        - [3. 关联子查询](#3-%E5%85%B3%E8%81%94%E5%AD%90%E6%9F%A5%E8%AF%A2)

## 基本概念

### 1. 数据库和数据库管理系统

数据库(Database): 是将大量数据保存起来，通过计算机加工而成的可以进行高效访问的**数据集合**。

DBMS (Database Management System):用来管理数据库的计算机系统称为数据库管理系统（DBMS）。

### 2. 数据库的种类

![11](数据库的分类.png)

### 3. Database和DBMS的作用

1. Database的作用

    - 实现数据共享
    - 减少数据的冗余度
    - 数据的独立性
    - 数据实现集中控制
    - 数据一致性和可维护性，以确保数据的安全性和可靠性
    - 故障恢复

2. DBMS的作用

    - **数据定义**：DBMS提供数据定义语言DDL（Data Definition Language），,供用户定义数据库的三级模式结构、两级映像以及完整性约束和保密限制等约束。DDL主要用于建立、修改数据库的库结构。DDL所描述的库结构仅仅给出了数据库的框架，数据库的框架信息被存放在数据字典（Data Dictionary）中。

    - **数据操作**：DBMS提供数据操作语言DML（Data Manipulation Language），供用户实现对数据的追加、删除、更新、查询等操作。
    - **数据库的运行管理**：数据库的运行管理功能是DBMS的运行控制、管理功能，包括多用户环境下的并发控制、安全性检查和存取限制控制、完整性检查和执行、运行日志的组织管理、事务的管理和自动恢复，即保证事务的原子性。这些功能保证了数据库系统的正常运行。
    - **数据组织、存储与管理**：DBMS要分类组织、存储和管理各种数据，包括数据字典、用户数据、存取路径等，需确定以何种文件结构和存取方式在存储级上组织这些数据，如何实现数据之间的联系。数据组织和存储的基本目标是提高存储空间利用率，选择合适的存取方法提高存取效率。
    - **数据库的保护**：数据库中的数据是信息社会的战略资源，所以数据的保护至关重要。DBMS对数据库的保护通过4个方面来实现：数据库的恢复、数据库的并发控制、数据库的完整性控制、数据库安全性控制。DBMS的其他保护功能还有系统缓冲区的管理以及数据存储的某些自适应调节机制等。
    - **数据库的维护**：这一部分包括数据库的数据载入、转换、转储、数据库的重组合重构以及性能监控等功能，这些功能分别由各个使用程序来完成。
    - **通信**：DBMS具有与操作系统的联机处理、分时系统及远程作业输入的相关接口，负责处理数据的传送。对网络环境下的数据库系统，还应该包括DBMS与网络中其他软件系统的通信功能以及数据库之间的互操作功能。

3. 数据模型

    - 对象模型
    - 层次模型（轻量级数据访问协议）
    - 网状模型（大型数据储存）
    - 关系模型
    - 面向对象模型
    - 半结构化模型
    - 平面模型（表格模型，一般在形式上是一个二维数组。如表格模型数据Excel)

### 4. SQL概要

1. sql语句的种类(根据操作目的划分)

    - DDL(Data Definition Language):用来创建或者删除存储 数据用的数据库以及数据库中的表等对象。
      - CREATE:创建数据库和表等对象。
      - DROP:删除数据库和表等对象。
      - ALTER:修改数据库和表等对象的结构。

    - DML(Data Manipulation Language):查询或者变更表中的记录.
      - SELETE
      - INSERT
      - UPDATE
      - DELETE

    - DCL(Data Control Language):用来确认或者取消对数据库中的数据进行的变更。（事务控制）
      - COMMIT
      - ROLLBACK
      - GRANT
      - REVOKE

2. sql的基本书写规则
    - 以;(分号)结尾
    - 关键字不区分大小写。（推荐关键字大写）
    - 常数的书写
    - 日期和字符：用单引号括起来。
    - 数字直接书写

### 5. 创建数据库和表

1. 创建数据库
  `CREATE DATABASE <库名>;`

2. 创建表
    ```sql
          CREATE TABLE <表名>(
            <列名1><数据类型1>[列约束],
            <列名2><数据类型2>[列约束],
            ...
            [表约束1],[表约束2],...
          );
    ```
3. 命名规则
    - 只能使用半角英文字母、数字、下划线(_)作为数据库、表和列的名称。
    - 名称必须以半角英文字母作为开头。
    - 名称不能重复。

4. 常用数据类型:Integer,Char,Varchar,Date

5. 表操作
    - 删除表
      ```sql
      DROP TABLE <表名>；
      ```
      
    - 表定义更新：添加和删除列
      ```sql
      ALTER TABLE <表名> ADD COLUMN <列名> [列约束];
      ALTER TABLE <表名> DROP COLUMN <列名>;
      ```
    - 插入数据
      ```sql
      INSERT INTO <表名> VALUES (值列表);
      ```
    - 变更表名
     ```sql
      ALTER TABLE <原表名> RENAME TO <新表名>;
      ```

## 查询基础

### 1. SELECT语句基础

  ```sql
  SELECT <列名1>,... FROM <表名>;
  ```
1. 列的查询：
    - clause(子句):上面的语句包含SELECT和FROM两个子句。
    - 查询结果中的列的顺序和SELECT子句中的列顺序相同。
    - SELECT子句中使用*号表示所有列；此时结果中的列的顺序和创建表定义时的顺序相同。

2. 别名
    ```sql
    SELECT <列名1> AS <别名1>[,<列名2> AS <别名2>...] FROM <表名>;
    ```
    - tips:别名中间有空格时，要使用双引号.

3. DISTINCT关键字：去除重复行
    - 使用DISTINCT时,NULL也被视为一类值。
    - DISTINCT只能用在第一个列名前。

4. WHERE子句(根据条件筛选)
    ```sql
    SELECT * FROM <表名> [WHERE <条件表达式>];
    ```
    - SQL语句中的书写顺序(子句顺序)是固定的

5. 注释
    - 单行注释： --
    - 多行注释：/* */
    - 一条SQL语句中也可以插入注释。

### 2. 运算符

1. 算术运行符和比较运行符
    - 比较运算符：=,<>,>,<,>=,<=,IS NULL,IS NOT NULL.比较运算会的结果为逻辑值。
    - 不用记运算符的优先级，多用括号.
    - NULL参与运算:NULL参与算术运算和比较运算结果都为NULL(由于比较运算的结果为逻辑值，比较运算的结果NULL表示UNKONW)。即 (5 > null) is unkown 的值为true;
    - 对于字符串的比较使用字典顺序（ASCII码）进行比较.
    - 判断是否为NULL要用IS NULL和IS NOT NULL，不能用"xxx = NULL"

2. 逻辑运算符（AND,OR,NOT）:连接多个查询条件。
    - 真值(逻辑值):sql中有三种真值。TRUE,FLASE,UNKOWN.
    - 使用集合概念（将表的数据看作集合中的元素）。比较运算就是取某个集合的子集，逻辑运算就是求多个集合的and交集、or并集。not 补集.
    - AND和OR具有短路特性。

## 聚合与排序

### 1. 聚合函数

- 聚合：将多行汇总为一行。
- 聚合函数：用于汇总的函数。特点：输入多行，输出一行。
- 作为聚合函数的参数时，NULL值将会被忽略（不参与运算且不计入数量，特别注意：COUNt(),AVG()计算的值的数量为该列非NULL值的数量）。
- COUNT(*)统计表的行数,不忽略NULL(就算表的数据全是NULL也能计算出所有行数).

### 2. 分组统计（分类汇总GROUP BY）

  ```sql
      SELECT <C1>,[C2],... FROM <表名>
        WHERE <行筛选条件>
        GROUP BY <C1>,[C2],...
        HAVING <分组条件>
        ORDER BY <C1> [ASC|DESC],...;
 ```

  1. 分组

      - 聚合键（分组列）:GROUP BY子句中指定的列。也就是分组依据，可以指定多列组合。NULL值也可以作为一类分组依据。
      - WHERE 和 GROUP BY 同时使用时SQL语句的执行顺序：  FROM -> WHERE -> GROUP BY -> SELECT;
      - 聚合函数在分组使用时，统计的是每一个组的数据。
      - GROUP BY子句中不能使用别名.由于DBMS内部的执行顺序 GROUP BY在SELECT子句前执行，此时还没有产生别名。
      - GROUP BY分组的结果是无序的。
      - 在分组时，SELECT子句中使用的非聚合函数参数的列名，必须在分组条件中。此时SELECT能使用的要素：能使用的要素：常数，聚合函数，聚合键。

  2. 分类汇总
      - WHERE子句不能使用聚合函数. SELECT,HAVING,ORDER BY 子句中可以使用.

  3. 按条件进行分组. HAVING子句
      - HAVING子句能使用的要素：常数，聚合函数，聚合键。
      - 针对聚合键的条件(非聚合)写在WHERE中，不要写在HAVING中。因为WHERE执行速度更快。
        > 1. 使用COUNT等聚合函数对表进行操作时，DBMS内部的处理是进行排序处理(ORACLE使用HASH)，排序会大大增加机器的负担。因此使用WHERE先对数据进行过滤能够有效减少数据量从而降低排序的开销。但是HAVING子句是在排序后对数据进行分组时才执行。
        > 2. 使用WHERE的另外一个优势是，可以对WHERE使用的列创建索引，也能大幅提高执行速度。

### 3. 对查询结果进行排序(ORDER BY)

- ORDERBY子句用于对查询结果进行排序.ASC升序（默认），DESC降序。
- 指定多个排序键，当第一个排序键无法确认多个记录（查询结果）的先后顺序时（多条记录该列值相同），使用下一个排序键对这些记录进一步排序，依次类推，否则以随机顺序显示这些记录。
- 查询结果中对应排序键中的值为NULL是，这些记录会集中显示在开头或者末尾。
- 在ORDER BY中可以使用SELECT中未使用的列和聚合函数.

## 数据更新

### 1. 向表中插入数据:INSERT

  1. 单行插入
        ```sql
        INSERT INTO <表名> （列1,列2,...）values (值1,值2,...);
        ```
  2. 多行插入
        ```sql
        INSERT INTO <表名> （列1,列2,...）values (值列表1), (值列表2),...;
        ```
  3. 省略列名列表: INSERT插入数据时VALUES后的值列表对应全列时，可以省略列名列表。
  4. 插入NULL值，直接在值列表中使用NULL.
  5. 插入默认值。
      - 在值列表中对应的位置上使用**DEFUALT**关键字（推荐）。
  6. 插入时在列名列表中未指定的列的值为NULL（如果该列具有默认值，则值为默认值）。
  7. **从其他表中复制数据**（将一张表中的数据插入另一张表）
        ```sql
        INSERT ... SELECT ...;
        ```

### 2. 删除表中数据

  1. 使用DELETE删除
        ```sql
        DELETE FROM <表名> [WHERE<条件表达式>];
        ```
  2. 使用TRUNCATE
        ```sql
        TRUNCATE<表名>；
        ```
        - 该语句用于删除全部数据，且不在SQL标准中，且不同数据库执行后效果不同。（ORACLE中把TRUNCATE定义为DDL,执行后默认COMMIT，不能ROLLBACK。）

### 3. 更新表中数据

```SQL
UPDATE <表名> SET <列1 = 值1>,... WHERE<条件表达式>
```

### 4. 事务

1. 事务：同一个处理单元中执行的一系列数据操作集合。
    ```SQL
    事务开始语句;
    DML1;
    DML2;
    ...;
    事务结束语句(COMMIT或ROLLBACK);
    ```
    - COMMIT提交处理
    - ROLLBACK取消处理

2. 自动提交模式(一条SQL就是一个事务，此时DELETE数据不能ROLLBACK)

3. ACID
    - 原子性(Atomicity):事务里的操作要么全部执行，要么都不执行；要么全部成功，要么ROLLBACK。
    - 一致性(Consistency):事务中包含的处理要满足数据库已设置的约束。
    - 隔离性（Isolation):确保事务间的独立，一个事务执行完之前，其结果对其他事务不可见。
    - 持久性(Durability)：持久性也可以称为耐久性。指的是在事务(不论是 交还是回滚)结束后，DBMS 能够保证该时间点的数据状态会被保存的特性。即使由于系 统故障导致数据丢失，数据库也一定能通过某种手段进行恢复。

## 5. 复杂查询

### 1. 视图

1. 什么是视图
    视图：是在关系数据库中，将一组查询指令构成的结果集，组合成可查询的数据表的一种数据库对象。与数据表不同的是，数据表是一种实体结构(Physical Structure,存的是数据)，但视图是一种虚拟结构(Virtual Structure，存的是SQL指令)，在实体数据表中的改变都可以立刻反应在视图中，不过部分数据库管理系统也支持具更新能力的视图(Updatable View)。

2. 视图的作用
    - 可以将实体数据表隐藏起来，让外部程序的设计师无法得知实际的数据结构，降低数据库被攻击的风险。
    - 在多数的情况下，视图是只读的，外部程序无法直接通过视图修改数据(具更新能力的视图除外)。
    -简化查询，数据库管理员可以将高度复杂的查询，包装在视图中，外部程序只需要直接访问该视图即可取出需要的数据。所以应该将常用的查询SELECT语句做成视图。
    - 在视图中先行运行运算。
    - 视图可视为数据表，具有 JOIN 的能力。
    - 数据库中只需要存储定义，无须存储数据。

3. 创建视图
    ```sql
    CREATE VIEW <视图名>[(列名列表)] AS <SELECT语句>
    ```
4. 可更新的视图
    - SELECT子句未使用DISTINCT
    - FROM子句中只使用一张表
    - 未使用GROUP BY子句和HAVING子句

5. 删除视图
    ```sql
    DROP VIEW <视图名>;
    ```
    ```sql
    --删除多重视图
    DROP VIEW <视图名> CASCADE;
    ```

### 2. 子查询（嵌套查询）

1. 什么是子查询

    子查询就是一次性视图(SELECT语句),查询的数据源是一个SELECT语句的结果(FROM子句)。与视图的区别是，子查询在整个SELECT语句执行完之后就消失了。
2. 原则上子查询必须指定名称：AS关键字
3. 标量子查询（scalar subquery）

    标量：单一的意思。
    标量查询：就是查询结果为单一值(只有一行，一列)的查询。由于结果为单一值，常用在条件表达式里，也可以书写在任何能使用单一值的地方（如使用在SELECT子句中将查询结果充当常数列）。

### 3. 关联子查询

```sql
--查询商品表中 每一类商品的销售价格 大于 该类商品销售价格的平均值  的记录。
SELECT * FROM "product"  AS p1 WHERE sale_price > (SELECT AVG(sale_price) FROM product as p2 WHERE p1.product_type = p2.product_type GROUP BY product_type);

--上面这条SQL语句也可以省略子查询中的分组子句，因为在进行关联子查询时，子查询中使用的聚合函数，会以绑定的列作为分组依据进行分组。
SELECT * FROM "product"  AS p1 WHERE sale_price > (SELECT AVG(sale_price) FROM product as p2 WHERE p1.product_type = p2.product_type);
```

1. 什么是关联子查询

    将一个表中的一个或多个列作为比较依据，与子查询的数据源的相关列做关联，然后进行查询。(即查询时对多个查询中同一类（将这些列做为分组依据）的数据进行比较)
    对多个查询的数据源的列作关联：<表1>.<列1> = <表2>.<列2>
2. 为什么使用关联子查询

    因为用子查询参与查询条件时，子查询的返回的结果只能时一行一列（即子查询必须为标题子查询），当需要对分组中的每一个类型进行单独比较时，只能使用关联子查询。
3. 关联列书写的位置(作用域)：最里层的子查询的WHERE子句

    因为的别名作用域原因，外层查询不能识别内层查询的别名。
